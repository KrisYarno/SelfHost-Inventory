generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                  Int                   @id @default(autoincrement())
  username            String                @db.VarChar(255)
  passwordHash        String?               @db.VarChar(255)
  isAdmin             Boolean               @default(false)
  email               String                @unique(map: "email") @db.VarChar(255)
  isApproved          Boolean               @default(false)
  deletedAt           DateTime?             @db.DateTime(0)
  defaultLocationId   Int                   @default(1)
  emailAlerts         Boolean?              @default(false)
  phoneNumber         String?               @db.VarChar(20)
  smsVerified         Boolean               @default(false)
  minLocationEmailAlerts Boolean            @default(false)
  minLocationSmsAlerts   Boolean            @default(false)
  minCombinedEmailAlerts Boolean            @default(false)
  minCombinedSmsAlerts   Boolean            @default(false)
  inventory_logs      inventory_logs[]
  notificationHistory NotificationHistory[]
  deletedProducts     Product[]             @relation("DeletedProducts")
  auditLogs           AuditLog[]
  companies           UserCompany[]
  fulfilledOrders     ExternalOrder[]
  locations           Location              @relation(fields: [defaultLocationId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_user_default_location")

  @@index([defaultLocationId], map: "fk_user_default_location")
  @@index([deletedAt], map: "idx_user_deleted")
  @@map("users")
}

model Product {
  id                  Int                    @id @default(autoincrement())
  name                String                 @db.VarChar(255)
  baseName            String?                @db.VarChar(150)
  variant             String?                @db.VarChar(100)
  unit                String?                @db.VarChar(20)
  numericValue        Decimal?               @db.Decimal(10, 2)
  quantity            Int                    @default(0)
  location            Int                    @default(1)
  lowStockThreshold   Int?                   @default(1)
  costPrice           Decimal                @default(0.00) @db.Decimal(10, 2)
  retailPrice         Decimal                @default(0.00) @db.Decimal(10, 2)
  deletedAt           DateTime?              @db.DateTime(0)
  deletedBy           Int?
  inventory_logs      inventory_logs[]
  notificationHistory NotificationHistory[]
  product_locations   product_locations[]
  deletedByUser       User?                  @relation("DeletedProducts", fields: [deletedBy], references: [id])
  productLinks        ProductLink[]

  @@index([baseName, numericValue, variant], map: "idx_product_sorting")
  @@index([deletedAt], map: "idx_deleted")
  @@index([name], map: "idx_products_name_fulltext")
  @@index([baseName], map: "idx_products_baseName_fulltext")
  @@index([variant], map: "idx_products_variant_fulltext")
  @@index([baseName, variant, name], map: "idx_products_search_composite")
  @@index([deletedBy], map: "products_deletedBy_fkey")
  @@map("products")
}

model Location {
  id                Int                 @id
  name              String              @db.VarChar(100)
  inventory_logs    inventory_logs[]
  product_locations product_locations[]
  notificationHistory NotificationHistory[]
  users             User[]

  @@map("locations")
}

model inventory_logs {
  id         Int                    @id @default(autoincrement())
  userId     Int
  productId  Int
  delta      Int
  changeTime DateTime               @db.DateTime(0)
  locationId Int?
  logType    inventory_logs_logType @default(ADJUSTMENT)
  locations  Location?              @relation(fields: [locationId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_log_location")
  users      User                   @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "inventory_logs_ibfk_1")
  products   Product                @relation(fields: [productId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "inventory_logs_ibfk_2")

  @@index([locationId], map: "fk_log_location")
  @@index([productId, locationId, changeTime], map: "idx_inventory_logs_product_location_time_desc")
  @@index([logType, changeTime], map: "idx_inventory_logs_type_time")
  @@index([userId, changeTime, productId, locationId, delta], map: "idx_inventory_logs_user_covering")
  // Indices for reports system performance
  @@index([changeTime, productId, delta], map: "idx_logs_time_product_delta")
  @@index([productId, changeTime, delta], map: "idx_logs_product_time_delta")
}

model product_locations {
  id         Int      @id @default(autoincrement())
  productId  Int
  locationId Int
  quantity   Int      @default(0)
  /// Per-location minimum on hand; 0 disables the trigger
  minQuantity Int     @default(0)
  version    Int      @default(0)
  updatedAt  DateTime @default(now()) @updatedAt @db.DateTime(0)
  locations  Location @relation(fields: [locationId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_pl_location")
  products   Product  @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_pl_product")

  @@unique([productId, locationId], map: "unique_product_location")
  @@index([locationId], map: "fk_pl_location")
  @@index([version, updatedAt], map: "idx_product_locations_version")
  @@index([updatedAt], map: "idx_product_locations_updated")
}

model NotificationHistory {
  id               Int       @id @default(autoincrement())
  userId           Int
  productId        Int
  locationId       Int?
  notificationType String    @db.VarChar(50)
  sentAt           DateTime? @default(now()) @db.DateTime(0)
  location         Location? @relation(fields: [locationId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  products         Product   @relation(fields: [productId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_notif_product")
  users            User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_notif_user")

  @@index([userId, productId, locationId, notificationType], map: "idx_user_product_loc_type")
  @@index([userId, productId, notificationType], map: "idx_user_product_type")
  @@index([productId], map: "idx_notif_product")
  @@map("notification_history")
}

model AuditLog {
  id            Int      @id @default(autoincrement())
  userId        Int
  actionType    String   @db.VarChar(50)
  entityType    String   @db.VarChar(50)
  entityId      Int?
  batchId       String?  @db.VarChar(36)
  action        String   @db.Text
  details       Json?
  ipAddress     String?  @db.VarChar(45)
  userAgent     String?  @db.VarChar(255)
  affectedCount Int      @default(1)
  createdAt     DateTime @default(now()) @db.DateTime(0)
  user          User     @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_audit_user")

  @@index([userId], map: "idx_audit_user")
  @@index([actionType], map: "idx_audit_actionType")
  @@index([entityType, entityId], map: "idx_audit_entity")
  @@index([batchId], map: "idx_audit_batch")
  @@index([createdAt], map: "idx_audit_created")
  @@map("audit_logs")
}

enum inventory_logs_logType {
  ADJUSTMENT
  TRANSFER
}

// Organizational Layer
model Company {
  id           String        @id @default(cuid())
  name         String
  slug         String        @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  users        UserCompany[]
  integrations Integration[]
  orders       ExternalOrder[]
  // Products are GLOBAL (shared inventory) - accessed via ProductLink through integrations

  @@map("companies")
}

model UserCompany {
  userId    Int
  companyId String
  user      User     @relation(fields: [userId], references: [id])
  company   Company  @relation(fields: [companyId], references: [id])

  @@id([userId, companyId])
  @@map("user_companies")
}

// Integration Layer
model Integration {
  id            String   @id @default(cuid())
  companyId     String
  platform      String   @db.VarChar(50) // "SHOPIFY", "WOOCOMMERCE"
  name          String   @db.VarChar(255)
  storeUrl      String   @db.VarChar(500)

  encryptedApiKey    String?  @db.Text
  encryptedApiSecret String?  @db.Text
  webhookSecret      String?  @db.Text

  isActive      Boolean  @default(true)
  lastSyncAt    DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  company       Company  @relation(fields: [companyId], references: [id])
  orders        ExternalOrder[]
  productLinks  ProductLink[]

  @@index([companyId])
  @@index([platform])
  @@map("integrations")
}

// Product Linking Layer
model ProductLink {
  id                 String      @id @default(cuid())
  integrationId      String
  internalProductId  Int

  externalProductId  String      @db.VarChar(255)
  externalVariantId  String?     @db.VarChar(255)
  externalSku        String?     @db.VarChar(255)
  externalTitle      String?     @db.VarChar(500)

  createdAt          DateTime    @default(now())

  integration        Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  internalProduct    Product     @relation(fields: [internalProductId], references: [id])
  orderItems         ExternalOrderItem[]

  @@unique([integrationId, externalProductId, externalVariantId])
  @@index([internalProductId])
  @@map("product_links")
}

// Order Storage Layer
model ExternalOrder {
  id              String      @id @default(cuid())
  companyId       String
  integrationId   String

  externalId      String      @db.VarChar(255)
  orderNumber     String      @db.VarChar(100)

  nativeStatus    String      @db.VarChar(100)
  financialStatus String?     @db.VarChar(100)
  fulfillmentStatus String?   @db.VarChar(100)

  total           Decimal     @db.Decimal(10, 2)
  currency        String      @default("USD") @db.VarChar(10)
  customerEmail   String?     @db.VarChar(255)
  customerName    String?     @db.VarChar(255)

  rawPayload      Json

  internalStatus  String      @default("pending") @db.VarChar(50)
  fulfilledAt     DateTime?
  fulfilledBy     Int?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  externalCreatedAt DateTime?

  company         Company     @relation(fields: [companyId], references: [id])
  integration     Integration @relation(fields: [integrationId], references: [id])
  items           ExternalOrderItem[]
  fulfilledByUser User?       @relation(fields: [fulfilledBy], references: [id])

  @@unique([integrationId, externalId])
  @@index([companyId, internalStatus])
  @@index([companyId, createdAt])
  @@map("external_orders")
}

// Order Items Layer
model ExternalOrderItem {
  id              String        @id @default(cuid())
  orderId         String

  externalItemId  String?       @db.VarChar(255)
  externalProductId String      @db.VarChar(255)
  externalVariantId String?     @db.VarChar(255)

  name            String        @db.VarChar(500)
  sku             String?       @db.VarChar(255)
  quantity        Int
  fulfilledQty    Int           @default(0)
  price           Decimal       @db.Decimal(10, 2)

  productLinkId   String?
  isMapped        Boolean       @default(false)

  order           ExternalOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productLink     ProductLink?  @relation(fields: [productLinkId], references: [id])

  @@index([orderId])
  @@index([externalVariantId])
  @@map("external_order_items")
}
